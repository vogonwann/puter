app-id: lol.janjic.puter
runtime: org.gnome.Platform
runtime-version: '47'
sdk: org.gnome.Sdk

command: puter
build-options:
  append-path: /app/bin
  env:
    CARGO_HOME: /app/cargo
    RUSTFLAGS: "--remap-path-prefix /app/cargo=/app"
    CARGO_HTTP_MULTIPLEXING: "false"
    CARGO_NET_RETRY: "10"
    CARGO_HTTP_CHECK_REVOKE: "false"
    CARGO_HTTP_SSL_VERSION: "tlsv1.2"
    CARGO_REGISTRIES_CRATES_IO_INDEX: "sparse+https://13.32.103.114/"

finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --filesystem=xdg-data/puter:create
  - --env=RUST_LOG=puter=debug
  - --env=G_MESSAGES_DEBUG=none
  - --share=network

modules:
  - name: rust
    buildsystem: simple
    build-commands:
      - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      - source /root/.cargo/env
      - rustup default stable
      - rustup target add x86_64-unknown-linux-gnu
      - install -Dm755 /root/.cargo/bin/* /app/bin/
    sources:
      - type: shell
        commands:
          - echo "Installing Rust"

  - name: puter
    buildsystem: simple
    build-commands:
      - cargo build --release
      - install -Dm755 target/release/puter /app/bin/puter
      - install -Dm644 lol.janjic.puter.desktop /app/share/applications/lol.janjic.puter.desktop
      - install -Dm644 lol.janjic.puter.metainfo.xml /app/share/metainfo/lol.janjic.puter.metainfo.xml
      - install -Dm644 data/icons/hicolor/scalable/apps/lol.janjic.puter.svg /app/share/icons/hicolor/scalable/apps/lol.janjic.puter.svg
      - install -Dm644 po/sr_RS/LC_MESSAGES/puter.mo /app/share/locale/sr_RS/LC_MESSAGES/puter.mo
    sources:
      - type: dir
        path: .